<% content_for :page_title, "#{@stage.name} - #{@project.name}" %>

<%= render partial: 'breadcrumbs', locals: { project: @project, stage: @stage } %>

<% if @stage.locked? %>
 <div class="alert alert-warning">Deployments to this stage were locked by <%= @stage.lock.user.name %> <%= time_ago_in_words(@stage.lock.created_at) %> ago. <%= @stage.lock.reason %></div>
<% end %>

<h1>
  <%= @stage.name %>
  <%= image_tag project_stage_path(@project, @stage, format: :svg, token: Rails.application.config.samson.badge_token), title: "Deploy badge" %>
</h1>

<section>
  <h2>Actions</h2>
  <div>
    <%= deploy_link @project, @stage %>
    <% if @stage.locked? %>
      <%= link_to project_stage_lock_path(@project, @stage), class: 'btn btn-default', method: :delete do %>
        <i class="glyphicon glyphicon-lock"></i> Unlock
      <% end %>
    <% else %>
      <button class="btn btn-default want-lock"><i class="glyphicon glyphicon-lock"></i> Lock</button>
      <%= form_tag project_stage_lock_path(@project, @stage), method: :post, class: 'before-lock' do %>
        <input type="text" name="description" class="lock-description" placeholder="Description">
        <button type="submit" class="do-lock btn btn-warning">Lock</button>
      <% end %>
    <% end %>

    <% if current_user.is_admin? %>
      <%= link_to "Edit stage", edit_project_stage_path(@project, @stage), class: "btn btn-default" %>
      <%= link_to project_stage_path(@project, @stage), class: 'btn btn-danger', method: :delete, data: { confirm: "Are you sure?" } do %>
        <i class="glyphicon glyphicon-remove"></i> Delete
      <% end %>
    <% end %>
  </div>

  <h2>Command</h2>
  <pre class="pre-command"><%= @stage.command %></pre>

  <% if @stage.has_children? %>
  <h2>Deploys to</h2>
  <table class="project-stages table table-condensed">
    <thead>
      <tr>
        <th>Name</th>
        <th>Deployer</th>
        <th>Release</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <%= render partial: "projects/stage", collection: @stage.children, locals: { project: @project, depth_offset: @stage.depth + 1 } %>
    </tbody>
  </table>
  <% end %>

  <h2>Recent deploys</h2>
  <table class="table">
    <thead>
      <tr>
        <th>When</th>
        <th>Who</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <%= render partial: "/projects/deploy", collection: @deploys %>
    </tbody>
  </table>
  <%= paginate @deploys %>
</section>
